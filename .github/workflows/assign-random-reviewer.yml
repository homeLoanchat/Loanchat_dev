name: Assign random reviewer

on:
  pull_request:
    types: [opened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write  # ì½”ë©˜íŠ¸ ì‘ì„±ìš©

env:
  REVIEWER_POOL: |
    juncity-kim
    jaeaeee
    doublejh0501
    zneda330
  REVIEWER_COUNT: "1"

jobs:
  roulette:
    runs-on: ubuntu-latest
    steps:
      - name: Pick random reviewer & request review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr || pr.draft) {
              core.notice("Draft PR or no PR payload â€“ skipping.");
              return;
            }

            // 1) í›„ë³´ í’€ ë¶ˆëŸ¬ì˜¤ê¸°
            const pool = (process.env.REVIEWER_POOL || "")
              .split("\n").map(s => s.trim()).filter(Boolean);

            // 2) ì‘ì„±ì / ì´ë¯¸ ìš”ì²­ëœ ë¦¬ë·°ì–´ ì œì™¸
            const author = pr.user.login.toLowerCase();
            let candidates = pool.filter(u => u.toLowerCase() !== author);

            const already = (pr.requested_reviewers || [])
              .map(u => u.login.toLowerCase());
            candidates = candidates.filter(u => !already.includes(u.toLowerCase()));

            if (candidates.length === 0) {
              core.notice("No available reviewers after excluding author/already-requested.");
              return;
            }

            // 3) ëœë¤ ì…”í”Œ + 1ëª… ì„ íƒ
            const need = Math.min(parseInt(process.env.REVIEWER_COUNT || "1", 10), candidates.length);
            for (let i = candidates.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
            }
            const chosen = candidates.slice(0, need);

            // 4) ë¦¬ë·°ì–´ ìš”ì²­
            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              reviewers: chosen,
            });

            // 5) ì½”ë©˜íŠ¸ ë‚¨ê¸°ê¸° (ìŠ¬ë™ êµ¬ë…ì´ ìˆë‹¤ë©´ ì´ ì½”ë©˜íŠ¸ê°€ ìŠ¬ë™ì—ë„ ìë™ ì „ì†¡ë¨)
            const body = `@${chosen.join(", @")} ë‹˜, ëœë¤ ë¦¬ë·° ë¯¸ì…˜ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤! ğŸš€\n\nì‘ì„±ì: @${pr.user.login}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body,
            });

            core.notice(`Requested review from: ${chosen.join(", ")}`);

            